<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Timing Challenge</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f0f0f0;
  padding: 20px;
  text-align: center;
}

header img {
  width: 80px;
  margin-bottom: 10px;
}

h1 {
  margin: 0;
  font-size: 32px;
}

.subtitle {
  font-size: 18px;
  color: #666;
}

.round-info {
  margin-top: 5px;
  font-size: 20px;
}

.digital {
  font-size: 48px;
  font-weight: bold;
  margin: 10px 0;
}

button {
  font-size: 18px;
  padding: 10px 20px;
  margin: 10px;
}

.history-container {
  margin-top: 30px;
}

.hiscore-box {
  font-size: 20px;
  margin: 10px 0;
}

.history table {
  margin: 0 auto;
  border-collapse: collapse;
  width: 80%;
}

.history th, .history td {
  border: 1px solid #ccc;
  padding: 8px;
}

#highScore, #globalHighScore { display:inline-block; }

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

#highScore.pulse,
#globalHighScore.pulse,
#restartBtn.pulse,
#shareBtn.pulse {
  animation: pulse 1s infinite;
}
  /* GDPR Banner */
#gdprBanner {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #1e40af;
  color: white;
  padding: 15px 20px;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.3);
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 1000;
  flex-wrap: wrap;

  /* lifted slightly so it doesnâ€™t overlap share buttons */
  bottom: 80px;
}

#gdprBanner p {
  margin: 0;
  font-size: 0.95rem;
}

#gdprBanner button {
  background: #10b981;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 0.9rem;
}

#gdprBanner button:hover {
  background: #059669;
}
</style>
</head>
<body>
<header>
  <img src="https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg">
  <h1>Timing Challenge</h1>
  <div class="subtitle">Keep within 500ms</div>
  <div class="round-info">Round: <span id="roundNumber">1</span></div>
</header>

<main>
  <button id="restartBtn">Restart</button>
  <div class="label">Target</div>
  <p id="targetTimeDisplay" class="digital">1000 ms</p>
  <div class="label">Live</div>
  <p id="liveTimer" class="digital">0 ms</p>
  <button id="actionBtn">Start</button>
  <button id="submitScoreBtn" style="display:none;">Submit Score</button>
</main>

<div class="history-container">
  <button id="shareBtn">Share</button>
  <div class="hiscore-box">
    Personal: <span id="highScore">0</span> | Global: <span id="globalHighScore">0</span>
  </div>
  <div class="history">
    <h2>Scores</h2>
    <table id="historyTable">
      <thead><tr><th>Round</th><th>Total</th><th>Score</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
let startTime = null, totalScore = 0, currentRound = 1, targetTime = 1000;
let gameOver = false, history = [];
let playerName = '', personalHighScore = 0, personalHighScoreNinja = 0;
let globalHighScore = 0;
let gameMode = 'normal';

const apiBase = "https://filerzh.azurewebsites.net/api/counter";

const actionBtn = document.getElementById('actionBtn');
const restartBtn = document.getElementById('restartBtn');
const shareBtn = document.getElementById('shareBtn');
const submitScoreBtn = document.getElementById('submitScoreBtn');
const historyTable = document.querySelector('#historyTable tbody');
const liveTimer = document.getElementById('liveTimer');
const targetTimeDisplay = document.getElementById('targetTimeDisplay');
const roundNumberEl = document.getElementById('roundNumber');
const highScoreEl = document.getElementById('highScore');
const globalHighScoreEl = document.getElementById('globalHighScore');
let timerInterval = null;

// Load personal highscores from cookies
personalHighScore = parseInt(document.cookie.replace(/(?:(?:^|.*;\s*)timing_highscore\s*\=\s*([^;]*).*$)|^.*$/, "$1")) || 0;
personalHighScoreNinja = parseInt(document.cookie.replace(/(?:(?:^|.*;\s*)timing_highscore_ninja\s*\=\s*([^;]*).*$)|^.*$/, "$1")) || 0;
updateHighScoreDisplay();


  // GDPR banner handling
const gdprBanner = document.getElementById('gdprBanner');
const gdprAcceptBtn = document.getElementById('gdprAcceptBtn');

// Check cookie for GDPR consent
const accepted = document.cookie.includes("timing_gdpr=1");

if (accepted) {
  gdprBanner.style.display = "none";
}

// Click to accept
gdprAcceptBtn.addEventListener("click", () => {
  document.cookie = "timing_gdpr=1; path=/; max-age=31536000";
  gdprBanner.style.display = "none";
});
  
function updateHighScoreDisplay() {
  highScoreEl.textContent = gameMode === 'normal' ? personalHighScore : personalHighScoreNinja;
  globalHighScoreEl.textContent = globalHighScore;
}

function endGame() {
  gameOver = true;
  actionBtn.disabled = true;
  restartBtn.classList.add('pulse');
  shareBtn.classList.add('pulse');
  submitScoreBtn.style.display = totalScore > 0 ? 'inline-block' : 'none';
}

function resetGame() {
  startTime = null;
  totalScore = 0;
  currentRound = 1;
  targetTime = 1000;
  gameOver = false;
  history = [];

  roundNumberEl.textContent = currentRound;
  targetTimeDisplay.textContent = `${targetTime} ms`;
  liveTimer.textContent = '0 ms';
  actionBtn.textContent = 'Start';
  actionBtn.disabled = false;

  restartBtn.classList.remove('pulse');
  shareBtn.classList.remove('pulse');
  submitScoreBtn.style.display = 'none';

  clearInterval(timerInterval);
  renderHistory();
  updateHighScoreDisplay();
}

actionBtn.addEventListener('click', () => {
  if (gameOver) return;

  if (startTime === null) {
    // Start timing
    startTime = performance.now();
    actionBtn.textContent = 'Stop';

    timerInterval = setInterval(() => {
      liveTimer.textContent = `${Math.round(performance.now() - startTime)} ms`;
    }, 30);
  } else {
    // Stop timing
    const elapsed = Math.round(performance.now() - startTime);
    startTime = null;
    clearInterval(timerInterval);

    liveTimer.textContent = `${elapsed} ms`;
    actionBtn.textContent = 'Start';

    let roundScore = 500 - Math.abs(targetTime - elapsed);
    if (roundScore < 0) roundScore = 0;

    totalScore += roundScore;
    let rowText = roundScore;

    if (roundScore === 0) {
      rowText += " - Game Over";
      endGame();
    } else if (currentRound === 10) {
      rowText += " - Finished! ðŸ†";
      endGame();
    }

    history.unshift({ round: currentRound, total: totalScore, score: rowText });
    renderHistory();

    // Personal highscore
    if ((gameMode === 'normal' && totalScore >= personalHighScore) ||
        (gameMode === 'ninja' && totalScore >= personalHighScoreNinja)) {
      
      if (gameMode === 'normal') {
        personalHighScore = totalScore;
        document.cookie = `timing_highscore=${personalHighScore}; path=/; max-age=31536000`;
      } else {
        personalHighScoreNinja = totalScore;
        document.cookie = `timing_highscore_ninja=${personalHighScoreNinja}; path=/; max-age=31536000`;
      }

      highScoreEl.classList.add('pulse');
    }

    // Global leaderboard: only pulse if would qualify
    fetch(`${apiBase}/wouldqualify/${gameMode}/${totalScore}`)
      .then(r => r.json())
      .then(qualifies => {
        if (qualifies) {
          globalHighScore = totalScore;
          globalHighScoreEl.classList.add('pulse');
          updateHighScoreDisplay();
        }
      });

    if (!gameOver) {
      currentRound++;
      targetTime = currentRound * 1000;
      roundNumberEl.textContent = currentRound;
      targetTimeDisplay.textContent = `${targetTime} ms`;
    }

    updateHighScoreDisplay();
  }
});

submitScoreBtn.addEventListener('click', () => {
  playerName = prompt('Enter your name to submit score:', playerName) || '';
  
  if (playerName) {
    fetch(`${apiBase}/submit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        playerName,
        total: totalScore,
        leaderboardName: gameMode
      })
    });

    submitScoreBtn.style.display = 'none';
  } else {
    submitScoreBtn.style.display = 'none';
  }
});

restartBtn.addEventListener('click', resetGame);

shareBtn.addEventListener('click', () => {
  if (history.length === 0) return;

  const latest = history[0];
  const message =
`https://pietrof.github.io/counter/
I managed to get to :
*Round ${latest.round} with Total ${latest.total}*
See if you can beat me!`;

  const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
});

function renderHistory() {
  historyTable.innerHTML = history
    .map(e => `<tr><td>${e.round}</td><td>${e.total}</td><td>${e.score}</td></tr>`)
    .join('');
}
</script>
  <div id="gdprBanner">
  <p>This site uses cookies to store your high scores. No personal data is shared.</p>
  <button id="gdprAcceptBtn">OK</button>
</div>
</body>
</html>
