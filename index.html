<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Timing Challenge</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<header>
  <img src="https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg">
  <h1>Timing Challenge</h1>
  <div class="subtitle">Keep within 500ms</div>
  <div class="round-info">Round: <span id="roundNumber">1</span></div>
  <button id="modeBtn">Mode: Normal</button>

</header>

<main>
  <button id="restartBtn">Restart</button>
  <div class="label">Target</div>
  <p id="targetTimeDisplay" class="digital">1000 ms</p>
  <div class="label">Live</div>
  <p id="liveTimer" class="digital">0 ms</p>
  <button id="actionBtn">Start</button>
</main>

<div class="history-container">
  <button id="shareBtn">Share</button>
  <div class="hiscore-box">
    Personal: <span id="highScore">0</span> | Global: <span id="globalHighScore">0</span>
  </div>
  <div class="history">
    <h2>Scores</h2>
    <table id="historyTable">
      <thead><tr><th>Round</th><th>Total</th><th>Score</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
let startTime = null, totalScore = 0, currentRound = 1, targetTime = 1000, gameOver = false, history = [];
let playerName = '', personalHighScore = 0, personalHighScoreNinja = 0, globalHighScore = 0;
let gameMode = 'normal';
const actionBtn = document.getElementById('actionBtn');
const restartBtn = document.getElementById('restartBtn');
const shareBtn = document.getElementById('shareBtn');

const historyTable = document.querySelector('#historyTable tbody');
const liveTimer = document.getElementById('liveTimer');
const targetTimeDisplay = document.getElementById('targetTimeDisplay');
const roundNumberEl = document.getElementById('roundNumber');
const highScoreEl = document.getElementById('highScore');
const globalHighScoreEl = document.getElementById('globalHighScore');
let timerInterval = null;

// Load personal highscore from cookie
personalHighScore = parseInt(document.cookie.replace(/(?:(?:^|.*;\s*)timing_highscore\s*\=\s*([^;]*).*$)|^.*$/, "$1")) || 0;
personalHighScoreNinja = parseInt(document.cookie.replace(/(?:(?:^|.*;\s*)timing_highscore_ninja\s*\=\s*([^;]*).*$)|^.*$/, "$1")) || 0;
updateHighScoreDisplay();

  const modeBtn = document.getElementById('modeBtn');

modeBtn.addEventListener('click', () => {
  gameMode = (gameMode === 'normal') ? 'ninja' : 'normal';
  modeBtn.textContent = `Mode: ${gameMode.charAt(0).toUpperCase() + gameMode.slice(1)}`;

  resetGame();   // restart rules + scoring immediately
  fetchGlobalHighscore();
  
  // Refresh high score display
  updateHighScoreDisplay();
});
  
function updateHighScoreDisplay() {
  highScoreEl.textContent = gameMode === 'normal' ? personalHighScore : personalHighScoreNinja;
  globalHighScoreEl.textContent = globalHighScore;
}
async function endGame() {
  gameOver = true;
  actionBtn.disabled = true;
  restartBtn.classList.add('pulse');
  shareBtn.classList.add('pulse');

  await fetchGlobalHighscore();

  // Automatically submit at end of game
  autoSubmitScore();
}
  function updateRoundDisplay() {
  if (playerName && playerName.trim() !== "") {
    roundNumberEl.textContent = `${playerName} - Round ${currentRound}`;
  } else {
    roundNumberEl.textContent = `Round ${currentRound}`;
  }
}
async function autoSubmitScore() {
  // Load stored player name, if any
  if (!playerName) {
    playerName = localStorage.getItem("timing_playerName") || "";
  }

  // If still no name, prompt once
  if (!playerName) {
    playerName = prompt("Enter your name for the leaderboard:") || "";
    if (playerName) {
      localStorage.setItem("timing_playerName", playerName);
    }
  }

  // If user canceled and name is still empty, do not submit
  if (!playerName.trim()) return;

  try {
    const response = await fetch(`${API_BASE}/submit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        playerName,
        total: totalScore,
        leaderboardName: gameMode
      })
    });

    const result = await response.json();
    console.log("Auto-submitted score:", result);
  } catch (err) {
    console.error("Failed to auto-submit score", err);
  }
}

  
function resetGame() {
  startTime = null; totalScore = 0; currentRound = 1; targetTime = 1000; gameOver = false; history = [];
  roundNumberEl.textContent = currentRound;
  targetTimeDisplay.textContent = `${targetTime} ms`;
  liveTimer.textContent = '0 ms';
  actionBtn.textContent = 'Start';
  actionBtn.disabled = false;
  restartBtn.classList.remove('pulse'); shareBtn.classList.remove('pulse');
  
  updateRoundDisplay();  // <-- use new helper
  
  clearInterval(timerInterval);
  renderHistory();
  updateHighScoreDisplay();
}

actionBtn.addEventListener('click', () => {
  if (gameOver) return;
  if (startTime === null) {
    startTime = performance.now();
    actionBtn.textContent = 'Stop';
    timerInterval = setInterval(() => {
    if (gameMode === 'normal') {
        // Normal = show live updates
        liveTimer.textContent = `${Math.round(performance.now() - startTime)} ms`;
    } else {
        // Ninja = frozen while running (do nothing)
        // liveTimer stays whatever it was (usually 0 ms)
    }
    }, 30);
  } else {
    const elapsed = Math.round(performance.now() - startTime);
    startTime = null; clearInterval(timerInterval); liveTimer.textContent = `${elapsed} ms`;
    actionBtn.textContent = 'Start';

    let roundScore = 500 - Math.abs(targetTime - elapsed); if (roundScore < 0) roundScore = 0;
    totalScore += roundScore;
    let rowText = roundScore;
    if (roundScore === 0) { rowText += ' - Game Over'; endGame(); }
    else if (currentRound === 10) { rowText += ' - Finished! ðŸ†'; endGame(); }

    history.unshift({ round: currentRound, total: totalScore, score: rowText }); renderHistory();

    // Update personal highscore
    if ((gameMode==='normal' && totalScore >= personalHighScore) || (gameMode==='ninja' && totalScore >= personalHighScoreNinja)) {
      if(gameMode==='normal'){ personalHighScore = totalScore; document.cookie = `timing_highscore=${personalHighScore}; path=/; max-age=31536000`; }
      else { personalHighScoreNinja = totalScore; document.cookie = `timing_highscore_ninja=${personalHighScoreNinja}; path=/; max-age=31536000`; }
      highScoreEl.classList.add('pulse');
    }

    // Update global highscore
    if(totalScore >= globalHighScore){ globalHighScore = totalScore; globalHighScoreEl.classList.add('pulse'); }

    updateHighScoreDisplay();

    if(!gameOver){ currentRound++; targetTime = currentRound*1000; roundNumberEl.textContent = currentRound; targetTimeDisplay.textContent = `${targetTime} ms`; }
  }
});
// Base API URL
const API_BASE = 'https://filerzh.azurewebsites.net/api/counter';

restartBtn.addEventListener('click', resetGame);

shareBtn.addEventListener('click', () => {
  if(history.length === 0) return;
  const latest = history[0];
  const message = `https://pietrof.github.io/counter/\nI managed to get to :\n*Round ${latest.round} with Total ${latest.total}*\nSee if you can beat me!`;
  const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
});

// Fetch global highscore for current mode
async function fetchGlobalHighscore() {
  try {
    const response = await fetch(`${API_BASE}/top?leaderboardName=${gameMode}`);
    const scores = await response.json();
    if(scores.length > 0){
      globalHighScore = scores[0].total;
      globalHighScoreEl.textContent = globalHighScore;
    } else {
      globalHighScore = 0;
      globalHighScoreEl.textContent = '0';
    }
  } catch(err) {
    console.error('Failed to fetch global highscores', err);
  }
}

function renderHistory() {
  historyTable.innerHTML = history.map(e => `<tr><td>${e.round}</td><td>${e.total}</td><td>${e.score}</td></tr>`).join('');
}
</script>
</body>
</html>


